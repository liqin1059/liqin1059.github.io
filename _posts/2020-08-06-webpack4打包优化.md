---
layout: post
title: webpack4打包优化
date: 2020-08-06 12:31:30
categories: webpack
tags:
---
# webpack4打包优化
针对vue cli3.0+，webpack4.0+，nodejs10.0+ 这几个版本打包优化

# 一、量化、分析

## speed-measure-webpack-plugin 时间分析

- 测量出在你的构建过程中，每一个 Loader 和 Plugin 的执行时长
- 而它的使用方法也同样简单，如下方示例代码所示，只需要在你导出 Webpack 配置时，为你的原始配置包一层 smp.wrap 就可以了，接下来执行构建，你就能在 console 面板看到如它 demo 所示的各类型的模块的执行时长

### demo
<img src="/assets/img/speed.png"/>

### 安装
```javascript
npm i speed-measure-webpack-plugin -D
```

### 使用
vue.config.js中配置

```javascript
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')
const smp = new SpeedMeasurePlugin({
  outputFormat: 'human'
})
module.exports = {
  configureWebpack: smp.wrap({
    plugins: []
  })
}
```

## webpack-bundle-analyzer 体积分析

- 分析打包后，各个文件的大小，用于分析 bundle 的
<img src="/assets/img/analyzer.png"/>

### 安装

```javascript
npm i webpack-bundle-analyzer -D
```

### 使用
```javascript
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;
module.exports = {
configureWebpack: {
   plugins: [
      new BundleAnalyzerPlugin()
    ]
  },
}
```

# 二、缓存
webpack缓存的插件有两个
- 缓存
## hard-source-webpack-plugin
HardSourceWebpackPlugin 为模块提供中间缓存步骤。为了查看结果，您需要使用此插件运行webpack两次：第一次构建将花费正常的时间。第二次构建将显着加快（大概提升90%的构建速度）

```javascript
npm i webpack-bundle-analyzer -D
```

```javascript
const HardSourceWebpackPlugin = require('hard-source-webpack-plugin')
module.exports = {
  configureWebpack: smp.wrap({
    plugins: [
      // 为模块提供中间缓存，缓存路径是：node_modules/.cache/hard-source
      new HardSourceWebpackPlugin(),
    ]
  })
}
```

# 三、多进程多实例构建，资源并行解析

多进程构建的方案比较知名的有以下三个
- thread-loader (推荐使用这个)
- HappyPack
- parallel-webpack

## thread-loader

```javascript
npm i thread-loader -D
```

```
module.exports = {
  configureWebpack: smp.wrap({
    module: {
      rules: [
        {
          test: /\.js$/,
          use: ['thread-loader']
        }
      ]
    }
  })
}
```

## HappyPack

```javascript
npm i happypack -D
```
```
const HappyPack = require('happypack');
const os = require('os');
const happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length });

module.exports = {
  configureWebpack: smp.wrap({
    plugins: [
      new HappyPack({
        id: 'babel',
        loaders: ['babel-loader?cacheDirectory=true'],
        threadPool: happyThreadPool
      })
    ]
  }),
  chainWebpack: config => {
		const jsRule = config.module.rule('js');
    jsRule.uses.clear();
    jsRule.use('happypack/loader?id=babel')
      .loader('happypack/loader?id=babel')
      .end();
	}
}

```

# 四、多进程多实例并行压缩

- 使用 parallel-uglify-plugin 插件
- uglifyjs-webpack-plugin 开启 parallel 参数
- terser-webpack-plugin 开启 parallel 参数 （推荐使用这个，支持 ES6 语法压缩）

## uglifyjs-webpack-plugin
通过开启 cache 配置开启我们的缓存功能，也可以通过开启 parallel 开启多核编译功能

```
npm i terser-webpack-plugin -D
```

```
const UglifyJsPlugin = require('uglifyjs-webpack-plugin');

module.exports = {
  configureWebpack: smp.wrap({
    optimization: {
      minimizer: [
        new UglifyJsPlugin({
          uglifyOptions: {
            warnings: false,
            parse: {},
            compress: {},
            mangle: true,
            output: null,
            toplevel: false,
            nameCache: null,
            ie8: false,
            keep_fnames: false
          },
          cache: true,
          parallel: true
        })
      ]
    }
  })
}
```